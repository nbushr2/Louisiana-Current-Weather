<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Louisiana Weather - Real-Time Conditions, Radar & Alerts</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --blue-sky: #4A90E2;
            --blue-dark: #2C5F8D;
            --lsu-purple: #461D7C;
            --lsu-gold: #FDD023;
            --gray-100: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-700: #495057;
            --alert-warning: #ffc107;
            --alert-severe: #dc3545;
            --alert-extreme: #721c24;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        #app-container {
            display: flex;
            height: 100vh;
        }
        
        #map-section {
            flex: 1;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        #forecast-panel {
            width: 420px;
            background: white;
            overflow-y: auto;
            box-shadow: -4px 0 20px rgba(0,0,0,0.1);
        }
        
        /* Severe Weather Alerts Banner */
        .alerts-banner {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: none;
        }
        
        .alerts-banner.active {
            display: block;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.9; }
        }
        
        .alerts-banner-content {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .alerts-banner-icon {
            font-size: 2rem;
            animation: shake 0.5s ease-in-out infinite;
        }
        
        @keyframes shake {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }
        
        .alerts-banner-text h3 {
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
        }
        
        .alerts-banner-text p {
            font-size: 0.9rem;
            opacity: 0.95;
        }
        
        /* Alerts Section */
        .alerts-section {
            padding: 1.5rem;
            border-bottom: 2px solid var(--gray-200);
            background: #fff3cd;
            display: none;
        }
        
        .alerts-section.active {
            display: block;
        }
        
        .alert-item {
            background: white;
            border-left: 4px solid var(--alert-severe);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .alert-item:last-child {
            margin-bottom: 0;
        }
        
        .alert-item.warning {
            border-left-color: var(--alert-warning);
        }
        
        .alert-item.severe {
            border-left-color: var(--alert-severe);
        }
        
        .alert-item.extreme {
            border-left-color: var(--alert-extreme);
            background: #f8d7da;
        }
        
        .alert-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }
        
        .alert-icon {
            font-size: 1.5rem;
            color: var(--alert-severe);
        }
        
        .alert-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--gray-700);
            flex: 1;
        }
        
        .alert-description {
            font-size: 0.9rem;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
            line-height: 1.5;
        }
        
        .alert-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
            color: var(--gray-700);
        }
        
        .alert-meta-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .location-header {
            background: linear-gradient(135deg, var(--blue-sky) 0%, var(--blue-dark) 100%);
            color: white;
            padding: 1.5rem;
        }
        
        .location-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        
        .location-subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .current-weather {
            padding: 2rem 1.5rem;
            background: linear-gradient(135deg, rgba(74, 144, 226, 0.05) 0%, rgba(44, 95, 141, 0.05) 100%);
            border-bottom: 1px solid var(--gray-200);
        }
        
        .current-temp {
            font-size: 4rem;
            font-weight: 300;
            color: var(--blue-dark);
            line-height: 1;
            margin-bottom: 0.5rem;
        }
        
        .current-condition {
            font-size: 1.2rem;
            color: var(--gray-700);
            margin-bottom: 1rem;
        }
        
        .weather-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .detail-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .detail-icon {
            font-size: 1.5rem;
            color: var(--blue-sky);
            width: 30px;
            text-align: center;
        }
        
        .detail-label {
            font-size: 0.75rem;
            color: var(--gray-700);
            text-transform: uppercase;
            margin-bottom: 0.25rem;
        }
        
        .detail-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--gray-700);
        }
        
        .forecast-section {
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .section-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--gray-700);
            margin-bottom: 1rem;
        }
        
        .hourly-scroll {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }
        
        .hourly-item {
            flex: 0 0 80px;
            background: white;
            border-radius: 12px;
            padding: 1rem 0.75rem;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .hourly-time {
            font-size: 0.85rem;
            color: var(--gray-700);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .hourly-icon {
            font-size: 2rem;
            margin: 0.5rem 0;
        }
        
        .hourly-temp {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--blue-dark);
        }
        
        .daily-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            background: white;
            border-radius: 12px;
            margin-bottom: 0.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .daily-day {
            flex: 0 0 100px;
            font-weight: 600;
            color: var(--gray-700);
        }
        
        .daily-icon {
            flex: 0 0 60px;
            text-align: center;
            font-size: 2rem;
        }
        
        .daily-forecast {
            flex: 1;
            font-size: 0.9rem;
            color: var(--gray-700);
            padding: 0 1rem;
        }
        
        .daily-temps {
            flex: 0 0 100px;
            display: flex;
            justify-content: space-between;
            font-weight: 600;
        }
        
        .temp-high { color: #dc3545; }
        .temp-low { color: var(--blue-sky); }
        
        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--gray-700);
        }
        
        .empty-state i {
            font-size: 4rem;
            color: var(--gray-300);
            margin-bottom: 1rem;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--gray-200);
            border-top-color: var(--blue-sky);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-top: 1rem;
            color: var(--gray-700);
            font-weight: 600;
        }
        
        /* Map Controls */
        .map-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: white;
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .map-controls h3 {
            font-size: 1rem;
            color: var(--gray-700);
            margin-bottom: 0.75rem;
        }
        
        .control-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .control-item:last-child {
            margin-bottom: 0;
        }
        
        .control-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .control-item label {
            font-size: 0.9rem;
            color: var(--gray-700);
            cursor: pointer;
        }
        
        /* Radar Controls */
        .radar-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: white;
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .radar-controls h3 {
            font-size: 1rem;
            color: var(--gray-700);
            margin-bottom: 0.75rem;
        }
        
        .radar-slider {
            width: 200px;
        }
        
        .radar-time {
            text-align: center;
            font-size: 0.85rem;
            color: var(--gray-700);
            margin-top: 0.5rem;
        }
        
        .radar-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
        
        .radar-btn {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--gray-300);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        
        .radar-btn:hover {
            background: var(--gray-100);
        }
        
        .radar-btn.active {
            background: var(--blue-sky);
            color: white;
            border-color: var(--blue-sky);
        }
        
        /* Alert Popup on Map */
        .leaflet-popup-content {
            margin: 0;
        }
        
        .alert-popup {
            min-width: 250px;
        }
        
        .alert-popup-header {
            background: var(--alert-severe);
            color: white;
            padding: 0.75rem;
            font-weight: 700;
            font-size: 1rem;
        }
        
        .alert-popup-body {
            padding: 1rem;
        }
        
        @media (max-width: 768px) {
            #forecast-panel {
                position: absolute;
                right: 0;
                width: 100%;
                max-width: 420px;
            }
            .map-controls {
                top: 10px;
                left: 10px;
                padding: 0.75rem;
            }
            .radar-controls {
                bottom: 10px;
                right: 10px;
                padding: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div id="app-container">
        <div id="map-section">
            <div id="map"></div>
            
            <div class="map-controls">
                <h3>Map Layers</h3>
                <div class="control-item">
                    <input type="checkbox" id="toggle-parishes" checked>
                    <label for="toggle-parishes">Parish Boundaries</label>
                </div>
                <div class="control-item">
                    <input type="checkbox" id="toggle-stations" checked>
                    <label for="toggle-stations">Weather Stations</label>
                </div>
                <div class="control-item">
                    <input type="checkbox" id="toggle-alerts" checked>
                    <label for="toggle-alerts">Severe Alerts</label>
                </div>
                <div class="control-item">
                    <input type="checkbox" id="toggle-radar">
                    <label for="toggle-radar">Weather Radar</label>
                </div>
            </div>
            
            <div class="radar-controls" id="radar-controls" style="display: none;">
                <h3><i class="fas fa-satellite-dish"></i> Radar Animation</h3>
                <input type="range" class="radar-slider" id="radar-slider" min="0" max="0" value="0">
                <div class="radar-time" id="radar-time">Loading...</div>
                <div class="radar-buttons">
                    <button class="radar-btn" id="radar-play"><i class="fas fa-play"></i> Play</button>
                    <button class="radar-btn" id="radar-refresh"><i class="fas fa-sync"></i> Refresh</button>
                </div>
            </div>
            
            <div class="loading-overlay" id="map-loading">
                <div class="spinner"></div>
                <div class="loading-text">Loading map...</div>
            </div>
        </div>
        
        <div id="forecast-panel">
            <!-- Severe Weather Alert Banner -->
            <div class="alerts-banner" id="alerts-banner" onclick="toggleAlerts()">
                <div class="alerts-banner-content">
                    <i class="fas fa-exclamation-triangle alerts-banner-icon"></i>
                    <div class="alerts-banner-text">
                        <h3>Active Weather Alerts</h3>
                        <p id="alerts-count">Loading...</p>
                    </div>
                </div>
            </div>
            
            <!-- Alerts Section (expandable) -->
            <div class="alerts-section" id="alerts-section"></div>
            
            <div id="forecast-content">
                <div class="empty-state">
                    <i class="fas fa-map-marker-alt"></i>
                    <h3>Select a Location</h3>
                    <p>Click anywhere on the map to view current conditions and forecast</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ========================================
        // CONFIGURATION
        // ========================================
        const GEOJSON_CONFIG = {
            stateBoundary: '/_fierce-draft/state-climate-office/_resources/weather-map/louisiana_state_boundary.geojson',
            parishBoundaries: '/_fierce-draft/state-climate-office/_resources/weather-map/louisiana_parishes.geojson'
        };
        
        let map;
        let stateLayer, parishLayer, stationsLayer, alertsLayer, radarLayers = [];
        let currentForecastData = null;
        let radarFrames = [];
        let currentRadarFrame = 0;
        let radarAnimationInterval = null;
        let currentAlerts = [];
        
        // Initialize map
        function initMap() {
            map = L.map('map', {
                center: [30.9843, -91.9623],
                zoom: 7,
                minZoom: 6,
                maxZoom: 12
            });
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap',
                maxZoom: 19
            }).addTo(map);
            
            // Load boundaries
            loadBoundaries();
            
            // Load weather data
            loadWeatherStations();
            loadSevereAlerts();
            
            // Click handler
            map.on('click', handleMapClick);
        }
        
        // Load boundaries from external GeoJSON
        async function loadBoundaries() {
            try {
                // Load state boundary
                const stateResponse = await fetch(GEOJSON_CONFIG.stateBoundary);
                if (stateResponse.ok) {
                    const stateData = await stateResponse.json();
                    stateLayer = L.geoJSON(stateData, {
                        style: { color: '#461D7C', weight: 3, fillColor: '#461D7C', fillOpacity: 0.1 }
                    }).addTo(map);
                    map.fitBounds(stateLayer.getBounds());
                }
                
                // Load parish boundaries
                const parishResponse = await fetch(GEOJSON_CONFIG.parishBoundaries);
                if (parishResponse.ok) {
                    const parishDataRaw = await parishResponse.json();
                    
                    let parishData;
                    if (parishDataRaw.features && parishDataRaw.features[0]?.geometry?.rings) {
                        parishData = {
                            type: "FeatureCollection",
                            features: parishDataRaw.features.map(f => ({
                                type: "Feature",
                                properties: f.attributes || {},
                                geometry: { type: "Polygon", coordinates: f.geometry.rings }
                            }))
                        };
                    } else {
                        parishData = parishDataRaw;
                    }
                    
                    parishLayer = L.geoJSON(parishData, {
                        style: { color: '#FDD023', weight: 1.5, fillOpacity: 0.05, fillColor: '#FDD023' },
                        onEachFeature: (feature, layer) => {
                            const name = feature.properties?.NAME || feature.attributes?.NAME || 'Unknown';
                            layer.bindTooltip(name + ' Parish', { permanent: false, direction: 'center' });
                        }
                    }).addTo(map);
                }
            } catch (error) {
                console.error('Error loading boundaries:', error);
                const bounds = [[33.02, -94.04], [28.93, -88.82]];
                stateLayer = L.rectangle(bounds, { color: '#461D7C', weight: 3, fillOpacity: 0.05 }).addTo(map);
                map.fitBounds(bounds);
            } finally {
                document.getElementById('map-loading').classList.add('hidden');
            }
        }
        
        // Load weather stations
        async function loadWeatherStations() {
            try {
                const response = await fetch('https://api.weather.gov/stations?state=LA&limit=20');
                const data = await response.json();
                
                stationsLayer = L.layerGroup().addTo(map);
                
                for (const station of data.features) {
                    try {
                        const coords = station.geometry.coordinates;
                        const obsResponse = await fetch(`${station.properties.id}/observations/latest`);
                        if (!obsResponse.ok) continue;
                        
                        const obsData = await obsResponse.json();
                        const obs = obsData.properties;
                        const temp = obs.temperature?.value ? (obs.temperature.value * 9/5 + 32).toFixed(1) : null;
                        
                        if (temp) {
                            const color = getTempColor(parseFloat(temp));
                            const marker = L.circleMarker([coords[1], coords[0]], {
                                radius: 8,
                                fillColor: color,
                                color: 'white',
                                weight: 2,
                                fillOpacity: 0.9
                            }).bindPopup(`
                                <strong>${station.properties.name}</strong><br>
                                Temperature: ${temp}°F<br>
                                Humidity: ${obs.relativeHumidity?.value?.toFixed(0) || 'N/A'}%<br>
                                Wind: ${obs.windSpeed?.value ? (obs.windSpeed.value * 0.621371).toFixed(1) : 'N/A'} mph
                            `).addTo(stationsLayer);
                        }
                    } catch (error) {}
                }
            } catch (error) {
                console.error('Error loading stations:', error);
            }
        }
        
        // Load severe weather alerts
        async function loadSevereAlerts() {
            try {
                const response = await fetch('https://api.weather.gov/alerts/active?area=LA');
                const data = await response.json();
                
                currentAlerts = data.features;
                
                if (currentAlerts.length > 0) {
                    displayAlertsBanner();
                    displayAlertsOnMap();
                }
            } catch (error) {
                console.error('Error loading alerts:', error);
            }
        }
        
        // Display alerts banner
        function displayAlertsBanner() {
            const banner = document.getElementById('alerts-banner');
            const count = document.getElementById('alerts-count');
            
            banner.classList.add('active');
            count.textContent = `${currentAlerts.length} active alert${currentAlerts.length > 1 ? 's' : ''} for Louisiana`;
            
            // Display alerts in section
            const section = document.getElementById('alerts-section');
            section.innerHTML = currentAlerts.map(alert => {
                const props = alert.properties;
                const severity = props.severity?.toLowerCase() || 'warning';
                const icon = getAlertIcon(props.event);
                
                return `
                    <div class="alert-item ${severity}">
                        <div class="alert-header">
                            <i class="${icon} alert-icon"></i>
                            <div class="alert-title">${props.event}</div>
                        </div>
                        <div class="alert-description">${props.headline}</div>
                        <div class="alert-meta">
                            <div class="alert-meta-item">
                                <i class="fas fa-clock"></i>
                                ${new Date(props.effective).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}
                            </div>
                            <div class="alert-meta-item">
                                <i class="fas fa-map-marker-alt"></i>
                                ${props.areaDesc?.split(';')[0] || 'Louisiana'}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Display alerts on map
        function displayAlertsOnMap() {
            alertsLayer = L.layerGroup().addTo(map);
            
            currentAlerts.forEach(alert => {
                const props = alert.properties;
                if (alert.geometry && alert.geometry.coordinates) {
                    const coords = alert.geometry.coordinates;
                    
                    L.geoJSON(alert.geometry, {
                        style: {
                            color: getAlertColor(props.severity),
                            weight: 2,
                            fillOpacity: 0.15,
                            fillColor: getAlertColor(props.severity)
                        }
                    }).bindPopup(`
                        <div class="alert-popup">
                            <div class="alert-popup-header">${props.event}</div>
                            <div class="alert-popup-body">
                                <strong>${props.headline}</strong><br><br>
                                <strong>Severity:</strong> ${props.severity}<br>
                                <strong>Urgency:</strong> ${props.urgency}<br>
                                <strong>Areas:</strong> ${props.areaDesc}
                            </div>
                        </div>
                    `).addTo(alertsLayer);
                }
            });
        }
        
        function getAlertIcon(event) {
            const e = event.toLowerCase();
            if (e.includes('tornado')) return 'fas fa-wind';
            if (e.includes('flood')) return 'fas fa-water';
            if (e.includes('hurricane')) return 'fas fa-hurricane';
            if (e.includes('thunderstorm')) return 'fas fa-bolt';
            if (e.includes('winter') || e.includes('snow')) return 'fas fa-snowflake';
            if (e.includes('heat')) return 'fas fa-temperature-high';
            return 'fas fa-exclamation-triangle';
        }
        
        function getAlertColor(severity) {
            const s = severity?.toLowerCase() || 'warning';
            if (s.includes('extreme')) return '#721c24';
            if (s.includes('severe')) return '#dc3545';
            return '#ffc107';
        }
        
        function toggleAlerts() {
            const section = document.getElementById('alerts-section');
            section.classList.toggle('active');
        }
        
        // Load radar imagery
        async function loadRadar() {
            try {
                const response = await fetch('https://api.rainviewer.com/public/weather-maps.json');
                const data = await response.json();
                
                radarFrames = data.radar.past.concat(data.radar.nowcast);
                
                const slider = document.getElementById('radar-slider');
                slider.max = radarFrames.length - 1;
                slider.value = radarFrames.length - 1;
                currentRadarFrame = radarFrames.length - 1;
                
                updateRadarFrame();
                
                document.getElementById('radar-controls').style.display = 'block';
            } catch (error) {
                console.error('Error loading radar:', error);
            }
        }
        
        function updateRadarFrame() {
            // Remove old radar layers
            radarLayers.forEach(layer => map.removeLayer(layer));
            radarLayers = [];
            
            if (radarFrames.length === 0) return;
            
            const frame = radarFrames[currentRadarFrame];
            const radarUrl = `https://tilecache.rainviewer.com${frame.path}/256/{z}/{x}/{y}/2/1_1.png`;
            
            const radarLayer = L.tileLayer(radarUrl, {
                opacity: 0.6,
                zIndex: 500
            });
            
            radarLayer.addTo(map);
            radarLayers.push(radarLayer);
            
            // Update time display
            const time = new Date(frame.time * 1000);
            document.getElementById('radar-time').textContent = time.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit' 
            });
        }
        
        function playRadar() {
            const btn = document.getElementById('radar-play');
            
            if (radarAnimationInterval) {
                clearInterval(radarAnimationInterval);
                radarAnimationInterval = null;
                btn.innerHTML = '<i class="fas fa-play"></i> Play';
                btn.classList.remove('active');
            } else {
                radarAnimationInterval = setInterval(() => {
                    currentRadarFrame = (currentRadarFrame + 1) % radarFrames.length;
                    document.getElementById('radar-slider').value = currentRadarFrame;
                    updateRadarFrame();
                }, 500);
                btn.innerHTML = '<i class="fas fa-pause"></i> Pause';
                btn.classList.add('active');
            }
        }
        
        function getTempColor(temp) {
            if (temp < 40) return '#0056b3';
            if (temp < 60) return '#17a2b8';
            if (temp < 75) return '#28a745';
            if (temp < 90) return '#ffc107';
            return '#dc3545';
        }
        
        // Handle map click for forecast
        async function handleMapClick(e) {
            const { lat, lng } = e.latlng;
            await loadForecast(lat, lng);
        }
        
        // Load forecast
        async function loadForecast(lat, lon) {
            const panel = document.getElementById('forecast-content');
            panel.innerHTML = '<div class="loading-overlay"><div class="spinner"></div><div class="loading-text">Loading forecast...</div></div>';
            
            try {
                const pointResponse = await fetch(`https://api.weather.gov/points/${lat.toFixed(4)},${lon.toFixed(4)}`);
                if (!pointResponse.ok) throw new Error('Location not available');
                
                const pointData = await pointResponse.json();
                const props = pointData.properties;
                
                const [forecastResponse, hourlyResponse] = await Promise.all([
                    fetch(props.forecast),
                    fetch(props.forecastHourly)
                ]);
                
                const forecastData = await forecastResponse.json();
                const hourlyData = await hourlyResponse.json();
                
                currentForecastData = {
                    location: `${props.relativeLocation.properties.city}, ${props.relativeLocation.properties.state}`,
                    daily: forecastData.properties.periods,
                    hourly: hourlyData.properties.periods.slice(0, 24)
                };
                
                displayForecast();
            } catch (error) {
                panel.innerHTML = `<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><h3>Unable to Load</h3><p>Try a different location</p></div>`;
            }
        }
        
        // Display forecast
        function displayForecast() {
            if (!currentForecastData) return;
            
            const current = currentForecastData.hourly[0];
            const html = `
                <div class="location-header">
                    <div class="location-title">${currentForecastData.location}</div>
                    <div class="location-subtitle">${new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}</div>
                </div>
                
                <div class="current-weather">
                    <div class="current-temp">${current.temperature}°F</div>
                    <div class="current-condition">${getWeatherIcon(current.shortForecast)} ${current.shortForecast}</div>
                    
                    <div class="weather-details">
                        <div class="detail-item">
                            <i class="fas fa-wind detail-icon"></i>
                            <div>
                                <div class="detail-label">Wind</div>
                                <div class="detail-value">${current.windSpeed}</div>
                            </div>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-tint detail-icon"></i>
                            <div>
                                <div class="detail-label">Precip</div>
                                <div class="detail-value">${current.probabilityOfPrecipitation?.value || 0}%</div>
                            </div>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-compress-arrows-alt detail-icon"></i>
                            <div>
                                <div class="detail-label">Humidity</div>
                                <div class="detail-value">${current.relativeHumidity?.value || 'N/A'}%</div>
                            </div>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-eye detail-icon"></i>
                            <div>
                                <div class="detail-label">Dewpoint</div>
                                <div class="detail-value">${current.dewpoint?.value ? Math.round(current.dewpoint.value * 9/5 + 32) + '°F' : 'N/A'}</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="forecast-section">
                    <div class="section-title"><i class="fas fa-clock"></i> Hourly Forecast</div>
                    <div class="hourly-scroll">
                        ${currentForecastData.hourly.slice(0, 12).map(hour => `
                            <div class="hourly-item">
                                <div class="hourly-time">${formatHour(hour.startTime)}</div>
                                <div class="hourly-icon">${getWeatherIcon(hour.shortForecast)}</div>
                                <div class="hourly-temp">${hour.temperature}°</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="forecast-section">
                    <div class="section-title"><i class="fas fa-calendar-alt"></i> 7-Day Forecast</div>
                    ${formatDailyForecast(currentForecastData.daily)}
                </div>
            `;
            
            document.getElementById('forecast-content').innerHTML = html;
        }
        
        function formatDailyForecast(periods) {
            const days = [];
            for (let i = 0; i < periods.length; i += 2) {
                const day = periods[i];
                const night = periods[i + 1];
                if (day) {
                    days.push(`
                        <div class="daily-item">
                            <div class="daily-day">${formatDay(day.startTime)}</div>
                            <div class="daily-icon">${getWeatherIcon(day.shortForecast)}</div>
                            <div class="daily-forecast">${day.shortForecast}</div>
                            <div class="daily-temps">
                                <span class="temp-high">${day.temperature}°</span>
                                <span class="temp-low">${night ? night.temperature + '°' : '—'}</span>
                            </div>
                        </div>
                    `);
                }
            }
            return days.join('');
        }
        
        function formatHour(dateString) {
            const date = new Date(dateString);
            const hours = date.getHours();
            return `${hours % 12 || 12}${hours >= 12 ? 'PM' : 'AM'}`;
        }
        
        function formatDay(dateString) {
            const date = new Date(dateString);
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            if (date.toDateString() === today.toDateString()) return 'Today';
            if (date.toDateString() === tomorrow.toDateString()) return 'Tomorrow';
            return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        }
        
        function getWeatherIcon(condition) {
            const lower = condition.toLowerCase();
            if (lower.includes('sunny') || lower.includes('clear')) 
                return '<i class="fas fa-sun" style="color: #ffc107;"></i>';
            if (lower.includes('cloud')) 
                return '<i class="fas fa-cloud" style="color: #6c757d;"></i>';
            if (lower.includes('rain')) 
                return '<i class="fas fa-cloud-rain" style="color: #4A90E2;"></i>';
            if (lower.includes('storm')) 
                return '<i class="fas fa-bolt" style="color: #dc3545;"></i>';
            if (lower.includes('snow')) 
                return '<i class="fas fa-snowflake" style="color: #17a2b8;"></i>';
            return '<i class="fas fa-cloud-sun" style="color: #ffc107;"></i>';
        }
        
        // Layer toggles
        document.getElementById('toggle-parishes').addEventListener('change', (e) => {
            if (parishLayer) {
                if (e.target.checked) map.addLayer(parishLayer);
                else map.removeLayer(parishLayer);
            }
        });
        
        document.getElementById('toggle-stations').addEventListener('change', (e) => {
            if (stationsLayer) {
                if (e.target.checked) map.addLayer(stationsLayer);
                else map.removeLayer(stationsLayer);
            }
        });
        
        document.getElementById('toggle-alerts').addEventListener('change', (e) => {
            if (alertsLayer) {
                if (e.target.checked) map.addLayer(alertsLayer);
                else map.removeLayer(alertsLayer);
            }
        });
        
        document.getElementById('toggle-radar').addEventListener('change', async (e) => {
            if (e.target.checked) {
                if (radarFrames.length === 0) await loadRadar();
                else radarLayers.forEach(layer => map.addLayer(layer));
                document.getElementById('radar-controls').style.display = 'block';
            } else {
                radarLayers.forEach(layer => map.removeLayer(layer));
                if (radarAnimationInterval) {
                    clearInterval(radarAnimationInterval);
                    radarAnimationInterval = null;
                    document.getElementById('radar-play').innerHTML = '<i class="fas fa-play"></i> Play';
                }
                document.getElementById('radar-controls').style.display = 'none';
            }
        });
        
        // Radar controls
        document.getElementById('radar-slider').addEventListener('input', (e) => {
            currentRadarFrame = parseInt(e.target.value);
            updateRadarFrame();
        });
        
        document.getElementById('radar-play').addEventListener('click', playRadar);
        
        document.getElementById('radar-refresh').addEventListener('click', async () => {
            radarFrames = [];
            await loadRadar();
        });
        
        // Initialize
        initMap();
    </script>
</body>
</html>
